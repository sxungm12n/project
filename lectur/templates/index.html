<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>과학썜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">
    <style>
        :root {
            --primary-blue: #e3f2fd;
            --secondary-blue: #bbdefb;
            --accent-blue: #90caf9;
            --text-color: #2c3e50;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --gradient-start: #64b5f6;
            --gradient-end: #1976d2;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        body {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            font-family: 'Noto Sans KR', sans-serif;
            min-height: 100vh;
            animation: fadeIn 0.5s ease-out;
            color: var(--text-color);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
            animation: fadeIn 0.8s ease-out;
        }
        .chat-container {
            background-color: var(--card-bg);
            border-radius: 30px;
            padding: 20px;
            height: 4000px;
            display: flex;
            flex-direction: column;
            position: relative;
            max-width: 400px;
            margin: 0 auto;
            border: 12px solid #333;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #f5f7fa, #e4e8eb);
        }
        .chat-container::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            z-index: 2;
        }
        .chat-container::after {
            content: '';
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 5px;
            background-color: #333;
            border-radius: 5px;
            z-index: 2;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 8px;
            margin: 10px 0 5px 0;
            border-radius: 20px;
            background-color: transparent;
            border: none;
            max-height: 3800px;
            position: relative;
            z-index: 1;
            backdrop-filter: blur(5px);
            padding-bottom: 80px;
        }
        .message {
            margin-bottom: 10px;
            padding: 12px 15px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
            line-height: 1.5;
            font-size: 0.95rem;
            position: relative;
            font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        .message-content {
            flex: 1;
            padding-right: 30px;
        }
        .user-message {
            background: linear-gradient(135deg, #6c9eff, #4a7dff);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            font-weight: 500;
            box-shadow: 0 4px 8px rgba(108, 158, 255, 0.3);
        }
        .assistant-message {
            background: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            color: #333;
            font-weight: 400;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .chat-input {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background-color: white;
            border-radius: 20px;
            margin: 8px;
            position: relative;
            z-index: 1;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .input-container input {
            width: 100%;
            border-radius: 15px;
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: #f8f9fa;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .button-container {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .button-container button {
            border-radius: 15px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #6c9eff, #4a7dff);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(108, 158, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .button-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 158, 255, 0.4);
        }
        .mic-button {
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .chat-input .action-button {
            background: white;
            color: #6c9eff;
            border: 2px solid #6c9eff;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-input .action-button:hover {
            background: linear-gradient(135deg, #6c9eff, #4a7dff);
            color: white;
        }
        .chat-input .file-input {
            display: none;
        }
        .quick-actions {
            display: flex;
            gap: 4px;
            margin: 6px 0;
            padding: 0 4px;
            justify-content: center;
        }
        .quick-actions button {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 3px;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid;
            background: white;
            min-width: 60px;
            justify-content: center;
        }
        .quick-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .quick-actions button i {
            font-size: 0.75em;
            transition: transform 0.2s ease;
        }
        .quick-actions .btn-outline-primary {
            color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .quick-actions .btn-outline-primary:hover {
            background: #0d6efd;
            color: white;
        }
        
        .quick-actions .btn-outline-info {
            color: #0dcaf0;
            border-color: #0dcaf0;
        }
        
        .quick-actions .btn-outline-info:hover {
            background: #0dcaf0;
            color: white;
        }

        .quick-actions .btn-outline-success {
            color: #198754;
            border-color: #198754;
        }
        
        .quick-actions .btn-outline-success:hover {
            background: #198754;
            color: white;
        }

        .quick-actions .btn-outline-warning {
            color: #ffc107;
            border-color: #ffc107;
        }
        
        .quick-actions .btn-outline-warning:hover {
            background: #ffc107;
            color: white;
        }
        .speaker-icon {
            position: absolute;
            right: -30px;
            bottom: 0;
            cursor: pointer;
            color: #64b5f6;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
        }
        .speaker-icon:hover {
            transform: scale(1.1);
            color: #1e88e5;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .speaker-icon i {
            font-size: 1em;
        }
        .summary-container, .news-container {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .news-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .news-item:last-child {
            border-bottom: none;
        }
        .news-item a {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
        }
        .news-date {
            font-size: 0.8em;
            color: #666;
        }
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            .chat-container {
                height: 500px;
                max-width: 350px;
            }
            .message {
                max-width: 90%;
                font-size: 0.9rem;
            }
            .chat-input input {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            .chat-input button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            .quick-actions button {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }
        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .file-upload-container {
            margin-top: 15px;
        }

        .upload-type-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .upload-type-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .upload-type-btn i {
            font-size: 1.1em;
        }

        .upload-type-btn.active {
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(30, 136, 229, 0.4);
        }

        .upload-info {
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .upload-box {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-box:hover {
            border-color: #1e88e5;
            background: #f8f9fa;
        }

        .upload-box i {
            font-size: 48px;
            color: #1e88e5;
            margin-bottom: 10px;
        }
        .result-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 30px var(--shadow-color);
            margin-bottom: 30px;
            height: 800px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out;
            color: black;
        }
        .chat-section {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 8px 30px var(--shadow-color);
            height: 600px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out;
            overflow: hidden;
        }
        .loading-message {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background-color: white;
            border-radius: 20px;
            margin-bottom: 15px;
            max-width: 85%;
            margin-right: auto;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .loading-dots {
            display: flex;
            gap: 8px;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            background: #1e88e5;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }
        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .download-btn {
            background: linear-gradient(135deg, var(--accent-blue), #64b5f6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            margin-top: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(144, 202, 249, 0.4);
        }
        .status-message {
            display: none;
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.9);
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, var(--accent-blue), #64b5f6);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            display: none;
            box-shadow: 0 8px 20px var(--shadow-color);
            animation: fadeIn 0.3s ease-out;
        }
        .section-title {
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
        }
        .section-title i {
            font-size: 1.6em;
            color: #64b5f6;
            background: linear-gradient(135deg, #64b5f6, #1e88e5);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h1 {
            color: var(--text-color);
            text-shadow: 0 2px 4px var(--shadow-color);
            font-weight: 700;
            margin-bottom: 2rem;
            animation: float 3s ease-in-out infinite;
            text-align: center;
            font-size: 2.5rem;
            padding: 20px 0;
        }
        .form-control {
            border-radius: 15px;
            padding: 12px 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #64b5f6;
            box-shadow: 0 0 0 0.2rem rgba(100, 181, 246, 0.25);
            transform: translateY(-2px);
        }
        .btn-primary {
            background: linear-gradient(135deg, #64b5f6, #1e88e5);
            border: none;
            border-radius: 15px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(100, 181, 246, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(100, 181, 246, 0.4);
        }
        /* 스크롤바 커스터마이징 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-end);
        }
        .markdown-body {
            color: black;
        }
        .news-item {
            margin: 10px 0;
                padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .news-item:hover {
            background-color: #e9ecef;
        }
        
        .news-item a {
            color: #0066cc;
            text-decoration: none;
            font-weight: 500;
        }
        
        .news-item a:hover {
            text-decoration: underline;
        }
        
        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .quick-actions {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            padding: 0 10px;
        }
        
        .quick-actions button {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .quick-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .quick-actions .btn-outline-primary {
            color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .quick-actions .btn-outline-primary:hover {
            background-color: #0d6efd;
            color: white;
        }
        
        .quick-actions .btn-outline-info {
            color: #0dcaf0;
            border-color: #0dcaf0;
        }
        
        .quick-actions .btn-outline-info:hover {
            background-color: #0dcaf0;
            color: white;
        }
        .summary-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .summary-content {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .keywords {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        
        .keyword-badge {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .news-item {
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        
        .news-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .news-keyword {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }
        .keyword-analysis {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 15px 0;
        }
        
        .keyword-category {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .keyword-category h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .keyword-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 3px;
            display: inline-block;
        }
        
        .keyword-badge.concept {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .keyword-badge.field {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .keyword-badge.search {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .academic-sources {
            margin: 15px 0;
        }
        
        .academic-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .academic-item h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .academic-content {
            line-height: 1.6;
            color: #555;
        }
        
        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
                padding: 20px;
            background: linear-gradient(135deg, #64b5f6, #1e88e5);
            border-radius: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 350px;
            margin: 0 auto 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .logo-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shine 3s infinite;
        }
        .logo {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transform: rotate(-5deg);
            animation: float 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
            padding: 8px;
            transition: all 0.3s ease;
        }
        .logo:hover {
            transform: rotate(-5deg) scale(1.05);
        }
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 0;
        }
        .logo-text {
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: float 3s ease-in-out infinite;
            animation-delay: 0.2s;
            position: relative;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .logo-text:hover {
            transform: translateY(-5px);
        }
        .logo-text::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
            animation: wave 2s infinite;
        }
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #64b5f6, #1e88e5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeOut 1s ease-out forwards;
            animation-delay: 2s;
        }
        .splash-logo {
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 8px 20px rgba(30, 136, 229, 0.4);
            transform: rotate(-5deg);
            background: white;
            border-radius: 30px;
            padding: 20px;
        }
        .splash-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 0;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        .splash-text {
            font-size: 3.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: float 3s ease-in-out infinite;
            animation-delay: 0.2s;
            letter-spacing: 3px;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        @keyframes shine {
            0% {
                transform: translateX(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) rotate(45deg);
            }
        }
        @keyframes wave {
            0% {
                transform: scaleX(0);
                opacity: 0;
            }
            50% {
                transform: scaleX(1);
                opacity: 1;
            }
            100% {
                transform: scaleX(0);
                opacity: 0;
            }
        }
        /* 언어 선택 메뉴 스타일 */
        .language-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 2px 0;
            margin-top: 2px;
            width: fit-content;
            min-width: unset;
        }
        
        .language-menu.show {
            display: block;
        }
        
        .language-option {
            padding: 2px 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-size: 0.65rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 2px;
            justify-content: center;
            min-width: unset;
            width: fit-content;
        }
        
        .language-option:hover {
            background-color: #f0f0f0;
            transform: translateX(1px);
        }

        .language-option::before {
            content: '🌐';
            font-size: 0.65em;
        }

        .mic-button {
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .mic-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(30, 136, 229, 0.4);
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #e53935, #c62828);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .upload-button {
            margin-top: 15px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(30, 136, 229, 0.4);
        }

        .upload-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .upload-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        .upload-status.success {
            display: block;
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .upload-status.error {
            display: block;
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .result-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .result-section h4 {
            margin-bottom: 15px;
            color: #1565c0;
        }

        .result-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .supported-formats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 5px;
        }

        .supported-formats span {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .supported-formats i {
            color: #1e88e5;
        }

        .action-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            margin: 0 5px;
        }

        .action-button:hover {
            background: linear-gradient(135deg, #357abd, #2a5f94);
            transform: translateY(-2px);
        }

        .action-button i {
            font-size: 16px;
        }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 20px;
        }

        .search-result {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .search-result h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .search-result a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .search-result a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="splash-screen">
        <div class="splash-logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="과학쌤 로고">
        </div>
        <div class="splash-text">과학쌤</div>
    </div>
    <div class="container">
        <div class="logo-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='logo-복사본.png') }}" alt="과학쌤 로고">
            </div>
            <div class="logo-text">과학쌤</div>
        </div>
        
        <h1 class="text-center mb-4"></h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="upload-section">
                    <h3>파일 업로드</h3>
                    <p>강의 내용을 업로드하세요</p>
                    <div class="file-upload-container">
                        <div class="upload-type-selector">
                            <button class="upload-type-btn active" data-type="audio">
                                <i class="fas fa-microphone"></i> 음성 파일
                            </button>
                            <button class="upload-type-btn" data-type="document">
                                <i class="fas fa-file-alt"></i> 문서 파일
                            </button>
                            </div>
                        <div class="upload-info audio-info">
                            <p>지원 형식: WAV</p>
                        </div>
                        <div class="upload-info document-info" style="display: none;">
                            <p>지원 형식:</p>
                            <div class="supported-formats">
                                <span><i class="fas fa-file-pdf"></i> PDF</span>
                                <span><i class="fas fa-file-excel"></i> Excel (XLSX, XLS)</span>
                                <span><i class="fas fa-file-word"></i> Word (DOCX)</span>
                                <span><i class="fas fa-file-powerpoint"></i> PowerPoint (PPTX)</span>
                                <span><i class="fas fa-file-alt"></i> Text (TXT)</span>
                            </div>
                        </div>
                        <form id="uploadForm">
                            <input type="file" id="fileInput" accept=".wav" style="display: none;">
                            <div class="upload-box" id="dropZone">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>파일을 드래그하거나 클릭하여 선택</p>
                                <p id="selectedFileName" style="margin-top: 10px; color: #1e88e5; font-weight: 500; display: none;"></p>
                            </div>
                            <button type="submit" class="upload-button">
                                <i class="fas fa-upload"></i> 업로드
                        </button>
                        </form>
                        <div id="uploadStatus" class="upload-status"></div>
                    </div>
            </div>

                <div class="result-section" id="resultSection" style="display: none;">
                    <h3 class="section-title"><i class="fas fa-file-alt"></i> 변환 결과</h3>
                            <div class="mb-3">
                        <h6>📝 텍스트:</h6>
                        <div id="textResult" class="border p-3 bg-light markdown-body"></div>
                        <button class="download-btn" onclick="downloadText()">
                            <i class="fas fa-download"></i> 텍스트 다운로드
                        </button>
                            </div>
                    <div class="mb-3">
                        <h6>📋 요약:</h6>
                        <div id="summaryResult" class="border p-3 bg-light markdown-body"></div>
                        <button class="download-btn" onclick="downloadSummary()">
                            <i class="fas fa-download"></i> 요약 다운로드
                        </button>
                </div>
            </div>
        </div>

            <div class="col-md-4">
                <div class="chat-section">
                    <h3 class="section-title"><i class="fas fa-robot"></i> 챗봇</h3>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="quick-actions">
                        <button onclick="summarizeLastQuestion()" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-alt"></i> 요약
                        </button>
                        <button onclick="searchWiki()" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-search"></i> 검색
                        </button>
                        <button class="btn btn-sm btn-outline-success" id="translateBtn">
                            <i class="fas fa-language"></i> 번역
                        </button>
                        <button onclick="generateImage()" class="btn btn-sm btn-outline-warning">
                            <i class="fas fa-image"></i> 그림
                        </button>
                    </div>
                    <div class="chat-input">
                        <div class="input-container">
                            <input type="text" id="userInput" placeholder="질문을 입력하세요...">
                            <div class="button-container">
                                <button id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                        </button>
                                <button id="micButton" class="mic-button">
                                    <i class="fas fa-microphone"></i>
                        </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div id="searchResult" class="search-result" style="display: none;">
        <h3>위키백과 검색 결과</h3>
        <div id="wikiLink"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 채팅 관련 스크립트
        const chatMessages = document.getElementById("chatMessages");
        const userInput = document.getElementById("userInput");

        // 초기 메시지 추가
        addMessage("안녕하세요! 과학쌤입니다. 과학에 대해 궁금한 점이 있으신가요? 제가 친절하게 설명해드릴게요. 어떤 것이든 편하게 물어보세요!", "assistant");
        addMessage("강의 내용을 업로드하시면 제가 그 내용을 바탕으로 답변해드릴게요!", "assistant");

        // 응답 포맷팅 함수 추가
        function formatResponse(text) {
            // 수학적 표현을 더 친근한 설명으로 변경
            text = text.replace(/\\[a-zA-Z]+/g, function(match) {
                switch(match) {
                    case '\\alpha': return '알파';
                    case '\\beta': return '베타';
                    case '\\gamma': return '감마';
                    case '\\theta': return '세타';
                    case '\\lambda': return '람다';
                    case '\\mu': return '뮤';
                    case '\\sigma': return '시그마';
                    case '\\pi': return '파이';
                    case '\\omega': return '오메가';
                    default: return match;
                }
            });

            // 전문 용어를 더 쉬운 설명으로 변경
            text = text.replace(/라그랑주/g, '라그랑주(물체의 운동을 설명하는 방법)');
            text = text.replace(/미분/g, '미분(변화율을 구하는 방법)');
            text = text.replace(/적분/g, '적분(면적을 구하는 방법)');
            text = text.replace(/벡터/g, '벡터(크기와 방향을 가진 양)');
            text = text.replace(/스칼라/g, '스칼라(크기만 있는 양)');

            // 선생님다운 톤으로 문장 시작
            text = text.replace(/^/, '자, 이제 설명해볼게요.\n\n');
            
            // 문장 끝에 친근한 표현 추가
            text = text.replace(/\.$/g, '입니다. 이해가 되었나요?');
            
            return text;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // 입력창과 버튼 비활성화
            userInput.disabled = true;
            document.querySelector('.chat-input button').disabled = true;
            document.querySelector('.quick-actions button').disabled = true;

            // 메시지 업로드
            try {
                const uploadResponse = await fetch("/upload_message", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        message: message
                    }),
                });

                const uploadData = await uploadResponse.json();
                if (!uploadData.success) {
                    console.error("메시지 업로드 실패:", uploadData.error);
                }
            } catch (error) {
                console.error("메시지 업로드 중 오류:", error);
            }

            addMessage(message, "user");
            userInput.value = "";
            
            // 로딩 메시지 추가
            const loadingMessage = document.createElement("div");
            loadingMessage.className = "loading-message";
            loadingMessage.innerHTML = `
                <span>답변을 준비하는 중입니다</span>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;
            chatMessages.appendChild(loadingMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: message }],
                    }),
                });

                const data = await response.json();
                
                // 로딩 메시지 제거
                loadingMessage.remove();

                if (data.response) {
                    const formattedResponse = formatResponse(data.response);
                    addMessage(formattedResponse, "assistant");
                } else if (data.error) {
                    addMessage("아, 죄송합니다. 잠시 문제가 발생했네요. 다시 시도해볼까요?", "assistant");
                } else {
                    addMessage("죄송합니다. 잠시 후 다시 시도해주세요.", "assistant");
                }
            } catch (error) {
                loadingMessage.remove();
                addMessage("아, 죄송합니다. 연결에 문제가 생겼네요. 잠시 후 다시 시도해주세요.", "assistant");
                console.error("오류:", error);
            } finally {
                // 입력창과 버튼 다시 활성화
                userInput.disabled = false;
                document.querySelector('.chat-input button').disabled = false;
                document.querySelector('.quick-actions button').disabled = false;
                userInput.focus();
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${sender}-message`;
            
            // 메시지 내용 컨테이너 생성
            const messageContent = document.createElement("div");
            messageContent.className = "message-content";
            messageContent.innerHTML = marked.parse(text);
            
            messageDiv.appendChild(messageContent);
            
            // 스피커 아이콘 추가 (assistant 메시지에만)
            if (sender === 'assistant') {
                const speakerIcon = document.createElement("div");
                speakerIcon.className = "speaker-icon";
                speakerIcon.innerHTML = '<i class="fas fa-volume-up"></i>';
                speakerIcon.style.cursor = "pointer";
                speakerIcon.style.color = "#64b5f6";
                speakerIcon.style.transition = "all 0.3s ease";
                
                // 호버 효과
                speakerIcon.addEventListener('mouseover', () => {
                    speakerIcon.style.transform = "scale(1.1)";
                    speakerIcon.style.color = "#1e88e5";
                });
                
                speakerIcon.addEventListener('mouseout', () => {
                    speakerIcon.style.transform = "scale(1)";
                    speakerIcon.style.color = "#64b5f6";
                });
                
                // TTS 기능
                speakerIcon.addEventListener('click', async () => {
                    try {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = text;
                        const plainText = tempDiv.textContent || tempDiv.innerText;
                        
                        const response = await fetch('/tts', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ text: plainText })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.audio_url) {
                                const audio = new Audio(data.audio_url);
                                audio.play().catch(error => {
                                    console.error('오디오 재생 오류:', error);
                                    showToast('오디오 재생에 실패했습니다.');
                                });
                            } else {
                                console.error('오디오 URL이 없습니다.');
                                showToast('오디오를 생성할 수 없습니다.');
                            }
                        } else {
                            const errorData = await response.json();
                            console.error('TTS 오류:', errorData.error);
                            showToast('음성 변환에 실패했습니다.');
                        }
                    } catch (error) {
                        console.error('TTS 오류:', error);
                        showToast('음성 변환 중 오류가 발생했습니다.');
                    }
                });
                
                messageDiv.appendChild(speakerIcon);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 파일 업로드 관련 변수
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const uploadTypeBtns = document.querySelectorAll('.upload-type-btn');
        const audioInfo = document.querySelector('.audio-info');
        const documentInfo = document.querySelector('.document-info');

        // 업로드 타입 선택
        uploadTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                uploadTypeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const type = btn.dataset.type;
                if (type === 'audio') {
                    fileInput.accept = '.wav';
                    audioInfo.style.display = 'block';
                    documentInfo.style.display = 'none';
                } else {
                    fileInput.accept = '.txt,.docx,.pptx,.xlsx';
                    audioInfo.style.display = 'none';
                    documentInfo.style.display = 'block';
                }
            });
        });

        // 파일 드롭 이벤트
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#1e88e5';
            dropZone.style.background = '#f8f9fa';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
            dropZone.style.background = 'white';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
            dropZone.style.background = 'white';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                updateSelectedFileName(files[0]);
            }
        });

        // 클릭으로 파일 선택
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        // 파일 선택 이벤트 핸들러
        function updateSelectedFileName(file) {
            const selectedFileName = document.getElementById('selectedFileName');
            if (file) {
                selectedFileName.textContent = `선택된 파일: ${file.name}`;
                selectedFileName.style.display = 'block';
            } else {
                selectedFileName.style.display = 'none';
            }
        }

        // 파일 입력 변경 이벤트
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                updateSelectedFileName(e.target.files[0]);
            }
        });

        // 파일 업로드 처리
        const uploadForm = document.getElementById('uploadForm');
        const uploadStatus = document.getElementById('uploadStatus');
        const resultSection = document.getElementById('resultSection');

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) {
                showToast('파일을 선택해주세요.');
                return;
            }

            // 파일 크기 체크 (100MB 제한)
            const maxSize = 100 * 1024 * 1024; // 100MB
            if (file.size > maxSize) {
                showToast('파일 크기가 100MB를 초과할 수 없습니다.');
                return;
            }

            // 업로드 버튼 비활성화 및 상태 표시
            const uploadButton = uploadForm.querySelector('button[type="submit"]');
            uploadButton.disabled = true;
            uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 처리중...';
            
            // 상태 메시지 표시
            uploadStatus.className = 'upload-status';
            uploadStatus.style.display = 'block';
            uploadStatus.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>파일을 처리하는 중입니다...</span>
                </div>
            `;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // 성공 상태 표시
                    uploadStatus.className = 'upload-status success';
                    uploadStatus.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-check-circle"></i>
                            <span>음성 파일이 성공적으로 처리되었습니다.</span>
                        </div>
                    `;

                    // 결과 섹션 표시
                    resultSection.style.display = 'block';
                    document.getElementById('textResult').textContent = data.text;
                    document.getElementById('summaryResult').innerHTML = marked.parse(data.summary);

                    // 챗봇에 메시지 추가
                    addMessage('파일이 성공적으로 처리되었습니다. 이제 파일 내용에 대해 질문해주세요!', 'assistant');
                    addMessage(`파일 내용 요약:\n${data.summary}`, 'assistant');

                    // 파일 선택 초기화
                    fileInput.value = '';
                    document.getElementById('selectedFileName').style.display = 'none';
                } else {
                    // 오류 상태 표시
                    uploadStatus.className = 'upload-status error';
                    uploadStatus.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>${data.error || '파일 처리 중 오류가 발생했습니다.'}</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.className = 'upload-status error';
                uploadStatus.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>파일 업로드 중 오류가 발생했습니다.</span>
                    </div>
                `;
            } finally {
                // 업로드 버튼 복원
                uploadButton.disabled = false;
                uploadButton.innerHTML = '<i class="fas fa-upload"></i> 업로드';
            }
        });

        // 파일 다운로드 함수
        function downloadText() {
            const text = document.getElementById('textResult').textContent;
            if (text) {
                const blob = new Blob([text], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lecture_text.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast('텍스트가 다운로드되었습니다.');
            } else {
                showToast('다운로드할 텍스트가 없습니다.');
            }
        }

        function downloadSummary() {
            const summary = document.getElementById('summaryResult').textContent;
            if (summary) {
                const blob = new Blob([summary], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lecture_summary.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast('요약이 다운로드되었습니다.');
            } else {
                showToast('다운로드할 요약이 없습니다.');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Enter 키로 메시지 전송
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 보내기 버튼 클릭 이벤트 추가
        document.getElementById('sendButton').addEventListener('click', () => {
            sendMessage();
        });

        // 마지막 질문 요약
        async function summarizeLastQuestion() {
            // 입력창과 버튼 비활성화
            userInput.disabled = true;
            document.querySelector('.chat-input button').disabled = true;
            document.querySelector('.quick-actions button').disabled = true;

            // 로딩 메시지 추가
            const loadingMessage = document.createElement("div");
            loadingMessage.className = "loading-message";
            loadingMessage.innerHTML = `
                <span>답변을 생성하고 요약하는 중입니다</span>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;
            chatMessages.appendChild(loadingMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch('/summarize_last', {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                // 로딩 메시지 제거
                loadingMessage.remove();
                
                if (data.error) {
                    addMessage(data.error, 'assistant');
                    return;
                }
                
                let message = `<div class="summary-container">
                    <h3>📝 요약</h3>
                    <div class="summary-content">${data.summary}</div>
                </div>`;
                
                addMessage(message, 'assistant');
                
            } catch (error) {
                loadingMessage.remove();
                console.error('오류:', error);
                addMessage('요약 중 오류가 발생했습니다.', 'assistant');
            } finally {
                // 입력창과 버튼 다시 활성화
                userInput.disabled = false;
                document.querySelector('.chat-input button').disabled = false;
                document.querySelector('.quick-actions button').disabled = false;
                userInput.focus();
            }
        }

        // 위키백과 검색 함수
        async function searchWiki() {
            // 입력창과 버튼 비활성화
            userInput.disabled = true;
            document.querySelector('.chat-input button').disabled = true;
            document.querySelector('.quick-actions button').disabled = true;

            // 로딩 메시지 추가
            const loadingMessage = document.createElement("div");
            loadingMessage.className = "loading-message";
            loadingMessage.innerHTML = `
                <span>위키백과를 검색하는 중입니다</span>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;
            chatMessages.appendChild(loadingMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                // 로딩 메시지 제거
                loadingMessage.remove();
                
                if (data.error) {
                    addMessage(data.error, 'assistant');
                    return;
                }
                
                // 검색 결과를 메시지로 표시
                addMessage(data.response, 'assistant');
                
            } catch (error) {
                loadingMessage.remove();
                console.error('오류:', error);
                addMessage('검색 중 오류가 발생했습니다.', 'assistant');
            } finally {
                // 입력창과 버튼 다시 활성화
                userInput.disabled = false;
                document.querySelector('.chat-input button').disabled = false;
                document.querySelector('.quick-actions button').disabled = false;
                userInput.focus();
            }
        }

        // 번역 버튼 클릭 이벤트 수정
        document.getElementById('translateBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // 기존 메뉴가 있다면 제거
            const existingMenu = document.querySelector('.language-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            // 마지막 메시지 확인
            const messages = document.querySelectorAll('.message');
            if (messages.length === 0) {
                showToast('번역할 메시지가 없습니다.');
                return;
            }
            
            const lastMessage = messages[messages.length - 1];
            if (!lastMessage.classList.contains('assistant-message')) {
                showToast('마지막 메시지가 어시스턴트의 메시지가 아닙니다.');
                return;
            }
            
            // 언어 선택 메뉴 생성
            const menu = document.createElement('div');
            menu.className = 'language-menu';
            menu.innerHTML = `
                <div class="language-option" data-lang="en">EN</div>
                <div class="language-option" data-lang="zh-Hans">中</div>
                <div class="language-option" data-lang="ja">日</div>
            `;
            
            // 메뉴 위치 설정
            const translateBtn = document.getElementById('translateBtn');
            const buttonRect = translateBtn.getBoundingClientRect();
            menu.style.position = 'absolute';
            menu.style.left = `${buttonRect.left}px`;
            menu.style.top = `${buttonRect.bottom + 5}px`;
            document.body.appendChild(menu);
            
            // 언어 선택 이벤트
            menu.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', async function() {
                    const targetLang = this.getAttribute('data-lang');
                    const messageContent = lastMessage.querySelector('.message-content');
                    
                    if (!messageContent) {
                        showToast('번역할 메시지 내용을 찾을 수 없습니다.');
                        return;
                    }
                    
                    // 메시지 텍스트 추출
                    const text = messageContent.textContent || messageContent.innerText;
                    if (!text.trim()) {
                        showToast('번역할 내용이 없습니다.');
                        return;
                    }
                    
                    try {
                        // 로딩 메시지 추가
                        const loadingMessage = document.createElement("div");
                        loadingMessage.className = "loading-message";
                        loadingMessage.innerHTML = `
                            <span>번역 중입니다</span>
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                        `;
                        chatMessages.appendChild(loadingMessage);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        // 번역 요청
                        const response = await fetch('/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                text: text,
                                target_lang: targetLang
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('번역 요청 실패');
                        }
                        
                        const data = await response.json();
                        
                        // 로딩 메시지 제거
                        loadingMessage.remove();
                        
                        if (data.translated) {
                            // 번역된 메시지 생성
                            const translatedMessage = document.createElement('div');
                            translatedMessage.className = 'message assistant-message';
                            
                            // 메시지 내용 추가
                            const messageContent = document.createElement('div');
                            messageContent.className = 'message-content';
                            messageContent.innerHTML = marked.parse(data.translated);
                            translatedMessage.appendChild(messageContent);
                            
                            // 스피커 아이콘 추가
                            const speakerIcon = document.createElement("div");
                            speakerIcon.className = "speaker-icon";
                            speakerIcon.innerHTML = '<i class="fas fa-volume-up"></i>';
                            
                            // TTS 기능 추가
                            speakerIcon.addEventListener('click', async function() {
                                try {
                                    const ttsResponse = await fetch('/tts', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({ text: data.translated })
                                    });
                                    
                                    if (ttsResponse.ok) {
                                        const ttsData = await ttsResponse.json();
                                        if (ttsData.audio_url) {
                                            const audio = new Audio(ttsData.audio_url);
                                            audio.play();
                                        }
                                    }
                                } catch (error) {
                                    console.error('TTS error:', error);
                                    showToast('음성 재생에 실패했습니다.');
                                }
                            });
                            
                            translatedMessage.appendChild(speakerIcon);
                            chatMessages.appendChild(translatedMessage);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        } else {
                            throw new Error(data.error || '번역 실패');
                        }
                    } catch (error) {
                        console.error('Translation error:', error);
                        showToast('번역 중 오류가 발생했습니다: ' + error.message);
                    } finally {
                        menu.remove();
                    }
                });
            });
            
            // 메뉴 외부 클릭 시 닫기
            const closeMenu = function(e) {
                if (!menu.contains(e.target) && e.target !== translateBtn) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 0);
        });

        // 이미지 생성 기능
        async function generateImage() {
            try {
                // 로딩 메시지 추가
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message assistant';
                loadingDiv.innerHTML = `
                    <div class="loading-message">
                        <span>그림을 생성중입니다</span>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                const response = await fetch('/generate_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                // 로딩 메시지 제거
                chatMessages.removeChild(loadingDiv);

                if (data.error) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message system';
                    messageDiv.innerHTML = marked.parse(data.error);
                    chatMessages.appendChild(messageDiv);
                } else {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message assistant';
                    messageDiv.innerHTML = `
                        <p>키워드 "${data.keyword}"에 대한 이미지를 생성했습니다:</p>
                        <img src="${data.image_url}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                    `;
                    chatMessages.appendChild(messageDiv);
                }

                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error generating image:', error);
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = marked.parse('이미지 생성 중 오류가 발생했습니다.');
                chatMessages.appendChild(messageDiv);
            }
        }

        // 음성 인식 기능
        let recognition = null;
        let isRecording = false;

        // 마이크 버튼 클릭 이벤트
        document.getElementById('micButton').addEventListener('click', () => {
            if (!recognition) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'ko-KR';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    document.getElementById('userInput').value = text;
                    sendMessage();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    alert('음성 인식 중 오류가 발생했습니다: ' + event.error);
                    stopRecording();
                };

                recognition.onend = () => {
                    stopRecording();
                };
            }

            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        function startRecording() {
            try {
                recognition.start();
                isRecording = true;
                document.getElementById('micButton').classList.add('recording');
                document.getElementById('micButton').innerHTML = '<i class="fas fa-stop"></i>';
            } catch (error) {
                console.error('Failed to start recording:', error);
                alert('음성 녹음을 시작할 수 없습니다. 마이크 권한을 확인해주세요.');
            }
        }

        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            document.getElementById('micButton').classList.remove('recording');
            document.getElementById('micButton').innerHTML = '<i class="fas fa-microphone"></i>';
        }

        // 페이지 로드 시 마이크 권한 요청
        window.addEventListener('load', () => {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        console.log('Microphone access granted');
                    })
                    .catch((error) => {
                        console.error('Microphone access denied:', error);
                        alert('마이크 접근이 거부되었습니다. 음성 입력을 사용하려면 마이크 권한을 허용해주세요.');
                    });
            } else {
                console.error('Speech recognition not supported');
                document.getElementById('micButton').style.display = 'none';
            }
        });
    </script>
</body>
</html> 